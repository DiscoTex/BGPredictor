<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Glucose Prediction Server</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        /* Base styles */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, "#74ABE2", "#5563DE");
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding-top: 60px;
        }
        .container {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            padding: 40px;
            max-width: 800px;
            width: 90%;
            margin: 0 auto;
        }
        h1, h2 {
            text-align: center;
            color: #333;
        }
        h1 {
            font-size: 2rem;
            margin-bottom: 5px;
        }
        h2 {
            margin-top: 30px;
            font-size: 1.5rem;
        }
        #prediction-info {
            text-align: center;
            margin-top: 20px;
            margin-bottom: 20px;
            font-size: 1.2rem;
            font-weight: bold;
            color: #222;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        input[type="submit"] {
            background-color: #5563DE;
            color: #fff;
            border: none;
            padding: 12px;
            border-radius: 4px;
            width: 100%;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 20px;
            transition: background-color 0.3s ease;
        }
        input[type="submit"]:hover {
            background-color: #4453c4;
        }
        hr {
            border: none;
            height: 1px;
            background: #e0e0e0;
            margin: 30px 0;
        }
        .progress {
            text-align: center;
            font-style: italic;
            color: #555;
            margin-bottom: 15px;
        }
        #plot {
            margin-bottom: 20px;
            width: 100%;
            height: 500px;
        }
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            h1 {
                font-size: 1.5rem;
            }
            h2 {
                font-size: 1.2rem;
            }
            #prediction-info {
                font-size: 1rem;
            }
            #plot {
                height: 350px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Page title -->
        <h1>Glucose Prediction Server</h1>
        
        <!-- Plot -->
        <div id="plot"></div>
        
        <!-- Display most recent BG value -->
        <div id="recent-bg" style="text-align: center; font-size: 1.6rem; margin-top: 15px;"></div>
        
        <!-- BG Alert for alarm messages -->
        <div id="bg-alert" style="text-align: center; font-size: 1.6rem; font-weight: bold; color: red; margin-top: 15px;"></div>
        
        <!-- Prediction info -->
        <div id="prediction-info">
            Last Prediction: <span id="last-timestamp">--:--:--</span>
        </div>
        
        <!-- Get Predictions Section -->
        <h2>Get Predictions</h2>
        <form id="predict-form">
            <!-- Removed Nightscout URL field -->
            <label for="model-predict">Model Path:</label>
            <input type="text" id="model-predict" name="model" value="{{ model_name }}">
            <input type="submit" value="Predict">
            <div id="predict-progress" class="progress"></div>
        </form>
        <hr>

        <!-- Retrain Model Section -->
        <h2>Train Model</h2>
        <form id="retrain-form" action="/retrain" method="post">
            <!-- Removed Nightscout URL field -->
            <label for="model-retrain">Model Path:</label>
            <input type="text" id="model-retrain" name="model" value="{{ model_name }}">
            <input type="submit" value="Train Model">
            <div id="retrain-progress" class="progress"></div>
        </form>
        <hr>
    </div>
    <script>
        // Handle the retrain form normally.
        document.getElementById('retrain-form').addEventListener('submit', function(e) {
            document.getElementById('retrain-progress').innerText = 'Retraining model, please wait...';
        });

        // Function to fetch predictions and update the plot and timestamp.
        function fetchPrediction() {
            document.getElementById('predict-progress').innerText = 'Generating predictions, please wait...';
            
            // Only the model path is now dynamic.
            const model = document.getElementById('model-predict').value;
            const query = `?model=${encodeURIComponent(model)}`;
            fetch('/predict' + query)
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('predict-progress').innerText = '';
                    if (data.error) {
                        alert(`Server Error: ${data.error}`);
                    } else if (data.predictions && data.recent) {
                        const now = new Date();
                        document.getElementById('last-timestamp').textContent = now.toLocaleTimeString();
                        
                        const timeStepsPred = data.predictions.map((_, index) => (index + 1) * 5);
                        const predTrace = {
                            x: timeStepsPred,
                            y: data.predictions,
                            mode: 'lines+markers',
                            type: 'scatter',
                            name: 'Predicted',
                            marker: { color: '#5563DE' }
                        };
                        
                        const timeStepsRecent = data.recent.map((_, index, arr) => ((index + 1) - arr.length) * 5);
                        const recentTrace = {
                            x: timeStepsRecent,
                            y: data.recent,
                            mode: 'lines+markers',
                            type: 'scatter',
                            name: 'Recent Actual',
                            marker: { color: '#E74C3C' }
                        };
                        
                        const layout = {
                            title: 'Glucose Predictions vs. Recent Values',
                            xaxis: { title: 'Time (minutes)' },
                            yaxis: { title: 'Glucose (mg/dL)', range: [40, 300] },
                            legend: {
                                orientation: 'h',
                                x: 0,
                                y: -0.3,
                                xanchor: 'left'
                            },
                            margin: { t: 50, b: 120 },
                            autosize: true,
                            shapes: [
                                {
                                    type: 'line',
                                    x0: 0,
                                    x1: 1,
                                    xref: 'paper',
                                    y0: 70,
                                    y1: 70,
                                    line: {
                                        color: 'red',
                                        width: 2,
                                        dash: 'dash'
                                    }
                                },
                                {
                                    type: 'line',
                                    x0: 0,
                                    x1: 1,
                                    xref: 'paper',
                                    y0: 250,
                                    y1: 250,
                                    line: {
                                        color: 'red',
                                        width: 2,
                                        dash: 'dash'
                                    }
                                }
                            ]
                        };
                        
                        Plotly.newPlot('plot', [predTrace, recentTrace], layout, { responsive: true });
                        
                        const lowBG = data.predictions.some(value => value < 70);
                        const alertEl = document.getElementById('bg-alert');
                        alertEl.innerText = lowBG ? "--> LOW BG PREDICTED WITHIN ONE HOUR!  <--" : "";
                        
                        const recentBG = data.recent[data.recent.length - 1];
                        document.getElementById('recent-bg').innerText = "Current BG: " + recentBG;
                    } else {
                        alert('Unexpected data format received from server.');
                        console.error('Received data:', data);
                    }
                })
                .catch(err => {
                    document.getElementById('predict-progress').innerText = '';
                    alert('Fetch or Processing Error: ' + err.message);
                    console.error('Fetch or Processing Error:', err);
                });
        }
        
        document.getElementById('predict-form').addEventListener('submit', function(e) {
            e.preventDefault();
            fetchPrediction();
        });
        
        window.addEventListener('load', function() {
            fetchPrediction();
        });
    </script>
</body>
</html>